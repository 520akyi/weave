#!/bin/bash

set -e
set -o pipefail

PRODUCT=net

fatal() {
    echo "$@" >&2
    exit 1
}

if [ ! -d .git ] ; then
    fatal "Current directory is not a git clone"
fi

if ! BRANCH=$(git symbolic-ref --short HEAD) || [ -z "$BRANCH" ] ; then
    fatal "Could not determine branch"
fi

case "$BRANCH" in
    issues/*)
        VERSION="${BRANCH#issues/}"
        ;;
    *)
        if echo "$BRANCH" | grep -qE '^[0-9]+\.[0-9]+' ; then
            DESCRIBE=$(git describe --match 'v*')
            if ! VERSION=$(echo "$DESCRIBE" | grep -oP '(?<=^v)[0-9]+\.[0-9]+\.[0-9]+') ; then
                fatal "Could not infer latest $BRANCH version from $DESCRIBE"
            fi
        else
            VERSION="$BRANCH"
        fi
        ;;
esac

echo ">>> Publishing $PRODUCT $VERSION site to $1"

wordepress --dry-run --url "$1" --user "$2" --password "$3" --product "$PRODUCT" --version "$VERSION" publish site
